
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.qz=e()}(this,function(){var t={VERSION:"2.2.1",DEBUG:!1,websocket:{connect:function(t){return qz.api.connect(t)},disconnect:function(){return qz.api.disconnect()},setErrorCallbacks:function(t,e,n){qz.websocket.errorHandler=t,qz.websocket.closedHandler=e,qz.websocket.refusedHandler=n},setOpenCallbacks:function(t,e){qz.websocket.openHandler=t,qz.websocket.secureHandler=e}},printer:null,printers:{find:function(t,e){var n={"output.requested":t,"criteria.requested":e};return qz.tools.promise(function(t,e){function o(){c.addEventListener("message",function(n){var i=n.data,a=JSON.parse(i);a.method?!/^(handleWebsocket|setHandler|setPromiseType|setDebug)$/.test(a.method)&&Object.keys(qz[a.method]).forEach(function(e){qz[a.method][e](a.params)}):t(a.result)},!1),c.addEventListener("error",function(t){e(t.data)},!1),c.addEventListener("close",function(t){e(t.data)},!1)}var c=new WebSocket("ws://localhost:8181");c.onopen=o})},getDefault:function(){return qz.websocket.dataPromise("printers.getDefault",{})},setDefault:function(t){return qz.websocket.dataPromise("printers.setDefault",{name:t})},getRaw:function(){return"raw"},getSerial:function(){return"serial"}},security:{setCertificatePromise:function(t){return qz.tools.promise(function(e,n){try{qz.security.setCertificate(t,e)}catch(t){n(t)}})},signRequest:function(e,n){if(!qz.tools.versionCompare(t.VERSION,"2.1")&&"undefined"==typeof n)return"");var o="",c=function(t,e){switch(t){case"hmac":{var n;try{n=e.sign(o,{algorithm:e.algorithm})}catch(t){throw t}return n}case"certificate":return e.sign(o);default:throw"Invalid signature algorithm. Use one of: hmac, certificate"}}};if(!n.promise&&"undefined"!=typeof n.sign){var i;try{i=c(e,n)}catch(t){return qz.tools.promise(function(e,n){n(t)})}return qz.tools.promise(function(t,e){t(i)})}return qz.tools.promise(function(i,a){n.promise(o).then(function(o){if(c(e,o)){var r;try{r=c(e,o)}catch(t){a(t)}i(r)}else a("The certificate function did not return a signed value.")})})}},file:{list:function(t,e){return"boolean"==typeof e&&(e={sandboxed:e}),qz.websocket.dataPromise("file.list",{path:t,params:e})},read:function(t){return qz.websocket.dataPromise("file.read",{path:t})},write:function(t,e){return qz.websocket.dataPromise("file.write",{path:t,data:e})}},websocket:{dataPromise:function(t,e,n){return qz.api.dataPromise(t,e,n)},isActive:function(){return qz.websocket.impl&&1==qz.websocket.impl.readyState}},api:{deploy:function(e){t.deployVersion=e},setSha:function(e){t.sha=e},connect:function(e){return qz.tools.promise(function(n,o){if(e&&"boolean"==typeof e)e={cors:e},console.warn("Boolean for websocket.connect() parameter is deprecated. Please use object: { cors: %s }",e.cors);else{e=e||{};var c=n;!function(){qz.api.promises=qz.api.promises||{};var t=qz.api.promises.connect;qz.api.promises.connect=n,n=function(e){t&&t(e),qz.api.promises.connect=null}}()}e&&e.host||(e.host=qz.tools.ws.getHost),e.retries||(e.retries=0),e.retries<0&&(e.retries=0),e.delay||(e.delay=0),qz.tools.ws.connection&&function(t,e,n){var o=!0,c=t.host;if(0==c.indexOf("localhost")||0==c.indexOf("127.0.0.1")){var i="localhost"==c||"127.0.0.1"==c?"localhost":"127.0.0.1"==c?c:"localhost";o=e(i,t.port),o||(o=e("127.0.0.1"==c?"localhost":"127.0.0.1",t.port))}else o=!1;o?n():e(c,t.port)}(e,"http"==location.protocol.substring(0,5)?function(e,n){var o=new XMLHttpRequest;return o.overrideMimeType&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.timeout=1e3,o.open("HEAD","http://"+e+(n&&isNaN(n)?":"+n:""),!1),o.send(null),o.readyState==o.DONE&&o.status!=404}:function(t,e){return!1},function(){qz.tools.ws.connection.cleanup(0,"Disconnecting for Connection to New Host",e);var t=function(){qz.tools.ws.connection=null,qz.api.connect(e).then(function(t){c(t)},function(t){o(t)})};setTimeout(t,5)})||qz.tools.ws.connection?qz.tools.ws.connection.setProperties(e).goodConnect?n(qz.tools.ws.connection):qz.tools.ws.connection.pending||o("Connection request already pending"):qz.tools.ws.connection=qz.tools.ws.setup(e,n,o)})},disconnect:function(){return qz.tools.promise(function(e,n){if(!qz.tools.ws.connection||2==qz.tools.ws.connection.impl.readyState||3==qz.tools.ws.connection.impl.readyState){n("No connection with QZ exists")}else{qz.tools.ws.connection.pending=!1;var o=function(t){2!==qz.tools.ws.connection.impl.readyState&&3!==qz.tools.ws.connection.impl.readyState?qz.tools.ws.connection.impl.close():t(!0)};o(function(t){t?e(!0):n("Unable to disconnect")})}})}},settings:{startOnLoad:!0,preemptive:null,usePrinterName:!1,useDefaultPrinter:!1,usingSecure:!1},tools:{isActive:function(){return qz.api.isActive.apply(null,arguments)},connection:{promise:{e:null,o:null},resolve:function(t){this.promise.e&&(this.promise.e.resolve(t),this.promise.e=null)},error:function(t){this.promise.o&&(this.promise.o.resolve(t),this.promise.o=null)}}},tools:{validURL:function(t){return new RegExp("^(http|https|file)://","i").test(t)},absolute:function(t){if(null==t)return null;var e=t.indexOf("/"),n=t.indexOf("://");return e>-1&&(0==e||n>0&&e==n+1)},relative:function(t){return null!=t&&qz.tools.validURL(t)},isBase64:function(t){try{return window.atob&&btoa(atob(t))==t}catch(t){return!1}},ws:{connection:null,setup:function(e,n,o){var c=1==e.attempts;e.attempts||(e.attempts=1),e.usingSecure=!0,e.securePrefix="wss://";var i;if(!("WebSocket"in window)){var a="WebSocket not supported";return console.error(a),o(a),null}var r,s=function(t){return t?t.includes(":")?t:t+":"+r:r};function u(t,c){i=new WebSocket(t+s(c)+"/"+e.version);var a=!1;return i.closed=!1,i.sessionId=null,i.established=!1,i.owner=e,i.setProperties=function(t){for(var e in t)void 0!==t[e]&&(i.owner[e]=t[e]);return i},i.sendData=function(t,e,n,o){t.timestamp=(new Date).getTime(),null==o?o=t&&"object"==typeof t&&t.constructor?JSON:null:"raw"===o&&(t={_:"blob",data:t}),i.send(JSON.stringify(t))},i.setSession=function(t){i.sessionId=t,i.established=!0},i.reset=function(){e.attempts=1,i.id=null,i.established=!1},i.opened=function(){0==a&&(a=!0,qz.tools.connection.resolve(!0),n(i))},i.onopen=function(){qz.tools.ws.deferredOpenSettings(i)},i.fail=function(t){o(t)},i.onmessage=function(t){var e=t.data;e=JSON.parse(e),e.method?!/^(handleWebsocket|setHandler|setPromiseType|setDebug)$/.test(e.method)&&Object.keys(qz[e.method]).forEach(function(t){qz[e.method][t](e.params)}):qz.tools.websocket.handleMessage(e)},i.onerror=function(){i.closed=!0,t==e.securePrefix&&(r=443)},i.onclose=function(){i.closed=!0,i.established&&qz.tools.ws.connection.error("Connection closed")},i.cleanup=function(t,e,n){i.id="closed",i.established=!1,e&&console.log(e),i.owner=n},i};i=function(t,a){var s=null;for(var l=0;l<t.length;++l)s=u(t[l],a);return s}(e.host instanceof Array?e.host:[e.host],e.port),r=e.port||8181;var l=e.openTimeout||n.timeout||6e5;return setTimeout(function(){i&&e.attempts==i.owner.attempts&&!i.established&&(i.established||(i.onclose=function(){}),i.close(),o("Timeout waiting for connection"))},l),i},deferredOpenSettings:function(e){if(qz.tools.ws.connection=e,qz.tools.connection.resolve(!0),e.established){if("function"==typeof e.owner.resolve){try{e.owner.resolve(e)}catch(t){console.error(t)}}return}var n={host:e.owner.host};try{e.send(JSON.stringify(n))}catch(t){console.error(t)}}},promise:function(t,e,n){function o(t){r||(r=!0,l&&l(t))}function c(t){r||(r=!0,s&&s(t))}function i(){try{var e=0==u||"function"!=typeof t?t:t();null==e?o(null):e.then(function(t){r||(r=!0,l&&l(t))},function(t){r||(r=!0,s&&s(t))})}catch(t){r||(r=!0,s&&s(t))}}var a={then:function(t,e){return s=e,l=t,r?a:this},catch:function(t){return this.then(void 0,t)},complete:function(t){return this.then(t,t),this},resolve:function(t){return r=!0,l&&l(t),this},reject:function(t){return r=!0,s&&s(t),this}},r=!1,s=void 0,l=void 0,u=arguments.length;return u>1&&(n=arguments[1],e=arguments[0],o=function(t){try{e(t)}catch(t){c(t)}},c=function(t){try{n(t)}catch(t){c(t)}},i()),a},websocket:{handleMessage:function(e){var n=e._,o=e.sid;switch(n){case"open":qz.tools.ws.connection.id=o;try{qz.tools.ws.connection.opened({id:o})}catch(t){console.error(t)}break;case"ok":case"info":console.log("Info:",e.data);break;case"log":console.log(e.data);break;case"error":throw console.error(e.data),e.data;case"close":qz.tools.ws.connection&&(qz.tools.ws.connection.id=void 0),console.warn("Closed:",e.data);break;case"data":var c=e.result;if("string"==typeof c&&qz.tools.isBase64(c))try{c=atob(c)}catch(t){console.error(t)}return qz.tools.websocket.resolveCreate(c);case"resolv":return qz.tools.websocket.resolvePromise(e.promise,e.result);case"reject":return qz.tools.websocket.rejectPromise(e.promise,e.result);case"event":return qz.tools.websocket.callEvent(e.eventType,e.result);default:console.warn("Cannot determine result for",e)}},resolveCreate:function(t){if(qz.tools.connection.resolve&&(console.log("Response:",t),qz.tools.connection.resolve(t)),!t||"undefined"==typeof t.name)return;t.name},resolvePromise:function(t,e){var n=qz.api.protocolPromise[t];n&&n.resolve(e),delete qz.api.protocolPromise[t]},rejectPromise:function(t,e){var n=qz.api.protocolPromise[t];if(n&&n.reject){var o=e;try{o="object"==typeof e?JSON.stringify(e):"string"==typeof e?e:"Unknown error"}catch(t){console.error(t),o=e}n.reject(o)}delete qz.api.protocolPromise[t]},callEvent:function(t,e){var n=qz.tools.event.handler[t];if(n)for(var o=0;o<n.length;o++)try{n[o](e)}catch(t){console.error("Event callback failed:",t)}}}}},e={},n={};return t.api.printers=n,e.init=function(){return t.api.init()},e});
